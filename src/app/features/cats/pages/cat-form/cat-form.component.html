<div class="container">
  <h1>{{ isEditMode ? 'Editar Gatito' : 'Agregar Nuevo Gatito' }}</h1>
  
  <form [formGroup]="catForm" (ngSubmit)="onSubmit()">
    <div class="image-upload">
      <ngx-dropzone
        [accept]="'image/jpeg,image/jpg,image/png,image/webp'"
        [maxFileSize]="5242880"
        (change)="onImageSelected($event)"
        [multiple]="false"
        [disabled]="uploadingImage"
      >
        @if (!selectedImage && !existingImageUrl) {
          <ngx-dropzone-label>
            <div class="upload-prompt">
              <mat-icon>cloud_upload</mat-icon>
              <p>Arrastra una imagen o haz clic para seleccionar</p>
              <small>Formatos permitidos: JPG, PNG, WEBP (máx. 5MB)</small>
            </div>
          </ngx-dropzone-label>
        } @else if (selectedImage) {
          <ngx-dropzone-image-preview [file]="selectedImage">
            <ngx-dropzone-label>{{ selectedImage.name }}</ngx-dropzone-label>
          </ngx-dropzone-image-preview>
        } @else if (existingImageUrl) {
          <img [src]="existingImageUrl" alt="Imagen actual" class="existing-image">
        }
      </ngx-dropzone>
      @if (uploadingImage) {
        <div class="upload-overlay">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Subiendo imagen...</span>
        </div>
      }
    </div>

    <div class="form-row">
      <mat-form-field class="form-field-full">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="name" required>
        <mat-error *ngIf="catForm.get('name')?.errors?.['required']">
          El nombre es requerido
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="form-field-full">
        <mat-label>Fecha de nacimiento</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="birthday" required>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field class="form-field-full">
        <mat-label>Juguete favorito</mat-label>
        <input matInput formControlName="favoriteToy" required>
      </mat-form-field>
      
      <mat-form-field class="form-field-full">
        <mat-label>Dueño</mat-label>
        <input matInput formControlName="ownerName" required>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field class="form-field-full">
        <mat-label>Raza</mat-label>
        <input matInput formControlName="breed" required>
      </mat-form-field>
      
      <mat-form-field class="form-field-full">
        <mat-label>Color del pelaje</mat-label>
        <input matInput formControlName="furColor" required>
      </mat-form-field>
    </div>

    <mat-form-field class="form-field-full">
      <mat-label>Descripción</mat-label>
      <textarea matInput formControlName="description" rows="3" required></textarea>
    </mat-form-field>

    <div class="personality-section">
      <h3>Personalidad</h3>
      <div class="personality-grid">
        @for (trait of personalityTraits; track trait) {
          <mat-checkbox [checked]="isTraitSelected(trait)" (change)="onTraitToggle($event, trait)">
            {{ trait }}
          </mat-checkbox>
        }
      </div>
    </div>

    <div class="fun-facts">
      <h3>Curiosidades</h3>
      <div formArrayName="funFacts">
        @for (fact of funFacts.controls; track fact; let i = $index) {
          <div class="fun-fact-item">
            <mat-form-field class="form-field-full">
              <mat-label>Curiosidad {{ i + 1 }}</mat-label>
              <input matInput [formControlName]="i">
            </mat-form-field>
            <button type="button" mat-icon-button color="warn" (click)="removeFunFact(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        }
      </div>
      <button type="button" mat-stroked-button (click)="addFunFact()">
        <mat-icon>add</mat-icon> Agregar curiosidad
      </button>
    </div>

    <div class="actions">
      <button 
        mat-raised-button 
        color="primary" 
        type="submit" 
        [disabled]="!catForm.valid || isSubmitting || uploadingImage"
      >
        @if (isSubmitting) {
          <mat-spinner diameter="24" class="button-spinner"></mat-spinner>
          <span>{{ isEditMode ? 'Guardando...' : 'Creando...' }}</span>
        } @else {
          <span>{{ isEditMode ? 'Guardar Cambios' : 'Guardar Gatito' }}</span>
        }
      </button>
      <button mat-button type="button" routerLink="/" [disabled]="isSubmitting">
        Cancelar
      </button>
    </div>
  </form>
</div>